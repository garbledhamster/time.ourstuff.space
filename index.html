<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ticket Time Tracker</title>

  <!-- FullCalendar (global bundle: core + daygrid + timegrid + interaction + list) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css">

  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --panel2:#0c142a;
      --card:#101b38;
      --border:rgba(255,255,255,.10);
      --muted:rgba(255,255,255,.65);
      --text:rgba(255,255,255,.92);
      --accent:#7aa2ff;
      --accent2:#9cf6d6;
      --danger:#ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --radius2:18px;
      --topbarH:56px;
      --ticketsW:360px;
      --minAppW:360px;
      --minAppH:560px;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 70% 0%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 600px at 0% 40%, rgba(156,246,214,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      overflow:hidden;
    }

    /* App frame */
    .app {
      height: 100vh;
      min-width: var(--minAppW);
      min-height: var(--minAppH);
      display:flex;
      flex-direction:column;
    }

    /* Top bar */
    .topbar{
      height: var(--topbarH);
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(10,15,30,.75);
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      letter-spacing:.2px;
      white-space:nowrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,.04);
    }
    .btn{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,.07); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      border-color: rgba(122,162,255,.45);
      background: rgba(122,162,255,.14);
    }
    .btn.primary:hover{ background: rgba(122,162,255,.18); }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: rgba(255,107,107,.10);
    }
    .btn.danger:hover{ background: rgba(255,107,107,.14); }

    .spacer{ flex:1; }

    .viewGroup{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    /* Main split */
    .main{
      flex:1;
      min-height: 0;
      display:flex;
      position:relative;
    }

    /* Tickets panel (desktop) */
    .tickets{
      width: var(--ticketsW);
      min-width: 300px;
      max-width: 420px;
      border-right: 1px solid var(--border);
      background: rgba(15,23,48,.70);
      backdrop-filter: blur(10px);
      display:flex;
      flex-direction:column;
      min-height:0;
    }

    .ticketsHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--border);
    }
    .ticketsHeader h2{
      margin:0 0 10px;
      font-size: 14px;
      letter-spacing:.2px;
      color: rgba(255,255,255,.85);
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .smallMuted{ color: var(--muted); font-size:12px; }

    .fieldRow{
      display:flex;
      gap:8px;
      margin-bottom:8px;
    }
    .input{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); }
    .input:focus{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 4px rgba(122,162,255,.14);
    }

    .ticketList{
      padding: 10px 10px 14px;
      overflow:auto;
      min-height:0;
    }

    .ticketItem{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius);
      padding: 10px 10px;
      margin-bottom: 10px;
      cursor: grab;
      user-select:none;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .ticketItem:active{ cursor:grabbing; }
    .dragHandle{
      width: 12px;
      height: 28px;
      border-radius: 10px;
      background: linear-gradient(to bottom, rgba(122,162,255,.55), rgba(156,246,214,.45));
      opacity:.9;
      margin-top: 2px;
      flex: 0 0 auto;
    }
    .ticketBody{
      flex:1;
      min-width:0;
    }
    .ticketKey{
      font-weight:800;
      letter-spacing:.2px;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ticketTitle{
      margin-top: 3px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      line-height: 1.25;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }
    .ticketMeta{
      margin-top: 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(255,255,255,.72);
      background: rgba(255,255,255,.03);
    }
    .iconBtn{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.85);
      padding: 6px 8px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:700;
    }
    .iconBtn:hover{ background: rgba(255,255,255,.06); }
    .iconBtn.danger{
      border-color: rgba(255,107,107,.25);
      color: rgba(255,107,107,.95);
    }

    /* Calendar region */
    .calendarWrap{
      flex:1;
      min-width: 0;
      background: rgba(12,20,42,.45);
      display:flex;
      flex-direction:column;
      min-height:0;
      padding: 12px;
    }
    .calendarCard{
      flex:1;
      min-height:0;
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(16,27,56,.30);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    #calendar{
      height: 100%;
      width: 100%;
    }

    /* Drawer (mobile) */
    .drawerOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.55);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .drawer{
      position:fixed;
      top:0;
      left:0;
      height: 100vh;
      width: min(92vw, 420px);
      transform: translateX(-105%);
      transition: transform .22s ease;
      z-index: 60;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      border-right: 1px solid var(--border);
      border-top-right-radius: 18px;
      border-bottom-right-radius: 18px;
      overflow:hidden;
    }
    .drawer.open{ transform: translateX(0%); }
    .drawerOverlay.open{
      opacity:1;
      pointer-events:auto;
    }

    /* Modal */
    .modalOverlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 80;
      padding: 18px;
    }
    .modalOverlay.open{ display:flex; }

    .modal{
      width: min(640px, 96vw);
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,23,48,.92);
      box-shadow: 0 30px 80px rgba(0,0,0,.6);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modalHeader{
      padding: 14px 14px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .modalHeader h3{
      margin:0;
      font-size: 14px;
      letter-spacing:.2px;
    }
    .modalHeader .sub{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      line-height: 1.25;
    }
    .modalBody{
      padding: 14px;
      display:grid;
      gap: 12px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .label{
      font-size: 12px;
      color: rgba(255,255,255,.72);
      margin: 0 0 6px;
    }
    textarea.input{
      min-height: 120px;
      resize: vertical;
    }
    .modalFooter{
      padding: 12px 14px 14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      border-top: 1px solid rgba(255,255,255,.10);
      flex-wrap:wrap;
    }

    /* Responsive rules */
    .mobileOnly{ display:none; }
    .desktopOnly{ display:inherit; }

    @media (max-width: 980px){
      .tickets{ display:none; } /* switch to drawer */
      .mobileOnly{ display:inherit; }
      .desktopOnly{ display:none; }
      .calendarWrap{ padding: 10px; }
    }

    /* FullCalendar theme tweaks */
    .fc{
      font-size: 12px;
      color: rgba(255,255,255,.90);
    }
    .fc .fc-toolbar-title{
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .2px;
      color: rgba(255,255,255,.92);
    }
    .fc .fc-button{
      border: 1px solid rgba(255,255,255,.12) !important;
      background: rgba(255,255,255,.04) !important;
      color: rgba(255,255,255,.90) !important;
      border-radius: 999px !important;
      padding: 7px 10px !important;
      box-shadow:none !important;
      text-transform: none !important;
      font-weight: 700 !important;
    }
    .fc .fc-button:hover{ background: rgba(255,255,255,.07) !important; }
    .fc .fc-button-primary:not(:disabled).fc-button-active{
      background: rgba(122,162,255,.18) !important;
      border-color: rgba(122,162,255,.45) !important;
    }
    .fc .fc-scrollgrid, .fc .fc-scrollgrid-section > *{
      border-color: rgba(255,255,255,.10) !important;
    }
    .fc .fc-timegrid-slot, .fc .fc-timegrid-axis, .fc .fc-col-header-cell, .fc .fc-daygrid-day{
      border-color: rgba(255,255,255,.08) !important;
    }
    .fc .fc-timegrid-now-indicator-line{
      border-color: rgba(156,246,214,.85) !important;
    }
    .fc .fc-event{
      border-radius: 10px !important;
      border-width: 1px !important;
    }
    .fc .fc-event-title{
      font-weight: 800;
    }
    .fc .fc-event-time{
      font-weight: 700;
      opacity:.9;
    }
    .fc .fc-daygrid-event{
      padding: 2px 4px !important;
    }
  </style>
</head>

<body>
  <div class="app">

    <!-- Top Bar -->
    <div class="topbar">
      <div class="brand pill" title="Ticket Time Tracker">
        <span style="font-size:14px;">⏱️</span>
        <span>Ticket Time</span>
      </div>

      <button class="btn mobileOnly" id="openDrawerBtn" title="Open ticket drawer">
        ☰ Tickets
      </button>

      <div class="spacer"></div>

      <div class="viewGroup">
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn" data-view="timeGridDay">Day</button>
        <button class="btn" data-view="timeGridWeek">Week</button>
        <button class="btn" data-view="dayGridMonth">Month</button>
        <button class="btn" data-view="listWeek">List</button>
      </div>
    </div>

    <div class="main">

      <!-- Desktop Tickets Panel -->
      <aside class="tickets desktopOnly" aria-label="Tickets panel">
        <div class="ticketsHeader">
          <h2>
            <span>Tickets</span>
            <span class="smallMuted" id="ticketsCount">0</span>
          </h2>

          <div class="fieldRow">
            <input class="input" id="ticketKeyInput" placeholder="Ticket ID or URL (e.g. 12345 or Zendesk link)" />
          </div>
          <div class="fieldRow">
            <input class="input" id="ticketTitleInput" placeholder="Title" />
          </div>
          <div class="fieldRow">
            <button class="btn primary" id="addTicketBtn">+ Add ticket</button>
            <button class="btn" id="exportBtn" title="Export time logs to CSV">Export CSV</button>
          </div>

          <div class="fieldRow" style="margin-bottom:0;">
            <input class="input" id="ticketSearchInput" placeholder="Search tickets..." />
          </div>
        </div>

        <div class="ticketList" id="ticketListDesktop"></div>
      </aside>

      <!-- Calendar -->
      <section class="calendarWrap" aria-label="Calendar area">
        <div class="calendarCard">
          <div id="calendar"></div>
        </div>
      </section>

      <!-- Mobile Drawer -->
      <div class="drawerOverlay" id="drawerOverlay"></div>
      <aside class="drawer tickets" id="drawer" aria-label="Tickets drawer">
        <div class="ticketsHeader">
          <h2>
            <span>Tickets</span>
            <span class="smallMuted" id="ticketsCountDrawer">0</span>
          </h2>

          <div class="fieldRow">
            <input class="input" id="ticketKeyInputDrawer" placeholder="Ticket ID or URL" />
          </div>
          <div class="fieldRow">
            <input class="input" id="ticketTitleInputDrawer" placeholder="Title" />
          </div>
          <div class="fieldRow">
            <button class="btn primary" id="addTicketBtnDrawer">+ Add</button>
            <button class="btn" id="exportBtnDrawer">Export</button>
            <button class="btn" id="closeDrawerBtn">Close</button>
          </div>

          <div class="fieldRow" style="margin-bottom:0;">
            <input class="input" id="ticketSearchInputDrawer" placeholder="Search tickets..." />
          </div>
        </div>

        <div class="ticketList" id="ticketListDrawer"></div>
      </aside>

    </div>
  </div>

  <!-- Event Edit Modal -->
  <div class="modalOverlay" id="modalOverlay" role="dialog" aria-modal="true" aria-label="Edit time log">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h3 id="modalTitle">Edit time log</h3>
          <div class="sub" id="modalSub">—</div>
        </div>
        <button class="btn" id="closeModalBtn">✕</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div>
            <div class="label">Start</div>
            <input class="input" id="modalStart" type="datetime-local" />
          </div>
          <div>
            <div class="label">End</div>
            <input class="input" id="modalEnd" type="datetime-local" />
          </div>
        </div>

        <div>
          <div class="label">Notes</div>
          <textarea class="input" id="modalNotes" placeholder="What did you do? (saved locally)"></textarea>
        </div>

        <div class="smallMuted" id="modalHint">
          Tip: Drag/resize blocks on the calendar. Double-click a block to edit notes.
        </div>
      </div>

      <div class="modalFooter">
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn danger" id="deleteEventBtn">Delete block</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" id="cancelModalBtn">Cancel</button>
          <button class="btn primary" id="saveModalBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <script>
    (() => {
      "use strict";

      // -----------------------------
      // Storage (IndexedDB via localForage)
      // -----------------------------
      const DB = localforage.createInstance({ name: "ticket-time-tracker", storeName: "v1" });
      const KEYS = {
        tickets: "tickets_v1",
        events: "events_v1"
      };

      // -----------------------------
      // Helpers
      // -----------------------------
      const $ = (id) => document.getElementById(id);
      const clamp = (n, min, max) => Math.max(min, Math.min(max, n));

      function toLocalInputValue(date) {
        // datetime-local wants "YYYY-MM-DDTHH:mm"
        const d = new Date(date);
        const pad = (x) => String(x).padStart(2, "0");
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth() + 1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const mi = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
      }

      function fromLocalInputValue(val) {
        // "YYYY-MM-DDTHH:mm" -> Date (local)
        // new Date(val) treats it as local in modern browsers
        const d = new Date(val);
        return isNaN(d.getTime()) ? null : d;
      }

      function addMinutes(date, minutes) {
        const d = new Date(date);
        d.setMinutes(d.getMinutes() + minutes);
        return d;
      }

      function safeUUID() {
        return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id-" + Math.random().toString(16).slice(2) + Date.now());
      }

      function extractTicketKey(raw) {
        const s = String(raw || "").trim();
        if (!s) return "";

        // Try Zendesk-ish: ".../tickets/12345"
        const m1 = s.match(/tickets\/(\d+)/i);
        if (m1 && m1[1]) return m1[1];

        // Try last big number in URL/text
        const m2 = s.match(/(\d{4,})\D*$/);
        if (m2 && m2[1]) return m2[1];

        // Fallback: keep trimmed
        return s;
      }

      function hashHue(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) h = (h * 31 + str.charCodeAt(i)) >>> 0;
        return h % 360;
      }

      function eventColors(ticketId) {
        const hue = hashHue(ticketId);
        // Use HSL but keep it subtle for dark UI
        return {
          backgroundColor: `hsla(${hue}, 80%, 55%, 0.20)`,
          borderColor: `hsla(${hue}, 85%, 60%, 0.55)`,
          textColor: `rgba(255,255,255,.95)`
        };
      }

      function normalizeTitle(ticketKey, title) {
        const key = ticketKey ? String(ticketKey).trim() : "";
        const t = title ? String(title).trim() : "";
        if (!key && !t) return "Untitled";
        if (key && t) return `${key} — ${t}`;
        return key || t;
      }

      function serializeCalendarEvents(calendar) {
        return calendar.getEvents().map(ev => ({
          id: ev.id,
          title: ev.title,
          start: ev.start ? ev.start.toISOString() : null,
          end: ev.end ? ev.end.toISOString() : null,
          allDay: !!ev.allDay,
          extendedProps: {
            ticketId: ev.extendedProps.ticketId || null,
            ticketKey: ev.extendedProps.ticketKey || null,
            notes: ev.extendedProps.notes || ""
          },
          ...eventColors(ev.extendedProps.ticketId || ev.id)
        }));
      }

      // Debounced save to avoid writing on every tiny interaction
      function debounce(fn, ms = 250) {
        let t = null;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), ms);
        };
      }

      // -----------------------------
      // State
      // -----------------------------
      let tickets = [];
      let calendar = null;

      const ui = {
        drawerOpen: false,
        activeEventId: null,
        lastClickByEventId: new Map()
      };

      // -----------------------------
      // DOM references
      // -----------------------------
      const dom = {
        // desktop
        ticketKeyInput: $("ticketKeyInput"),
        ticketTitleInput: $("ticketTitleInput"),
        addTicketBtn: $("addTicketBtn"),
        ticketSearchInput: $("ticketSearchInput"),
        ticketListDesktop: $("ticketListDesktop"),
        ticketsCount: $("ticketsCount"),
        exportBtn: $("exportBtn"),

        // drawer
        drawer: $("drawer"),
        drawerOverlay: $("drawerOverlay"),
        openDrawerBtn: $("openDrawerBtn"),
        closeDrawerBtn: $("closeDrawerBtn"),
        ticketKeyInputDrawer: $("ticketKeyInputDrawer"),
        ticketTitleInputDrawer: $("ticketTitleInputDrawer"),
        addTicketBtnDrawer: $("addTicketBtnDrawer"),
        ticketSearchInputDrawer: $("ticketSearchInputDrawer"),
        ticketListDrawer: $("ticketListDrawer"),
        ticketsCountDrawer: $("ticketsCountDrawer"),
        exportBtnDrawer: $("exportBtnDrawer"),

        // calendar controls
        todayBtn: $("todayBtn"),

        // modal
        modalOverlay: $("modalOverlay"),
        closeModalBtn: $("closeModalBtn"),
        cancelModalBtn: $("cancelModalBtn"),
        saveModalBtn: $("saveModalBtn"),
        deleteEventBtn: $("deleteEventBtn"),
        modalTitle: $("modalTitle"),
        modalSub: $("modalSub"),
        modalStart: $("modalStart"),
        modalEnd: $("modalEnd"),
        modalNotes: $("modalNotes")
      };

      // -----------------------------
      // Drawer controls
      // -----------------------------
      function setDrawerOpen(open) {
        ui.drawerOpen = !!open;
        if (ui.drawerOpen) {
          dom.drawer.classList.add("open");
          dom.drawerOverlay.classList.add("open");
        } else {
          dom.drawer.classList.remove("open");
          dom.drawerOverlay.classList.remove("open");
        }
      }

      // -----------------------------
      // Modal controls
      // -----------------------------
      function openModalForEvent(event) {
        ui.activeEventId = event.id;

        const ticketKey = event.extendedProps.ticketKey || "";
        const ticketTitle = (tickets.find(t => t.id === event.extendedProps.ticketId)?.title) || "";
        dom.modalTitle.textContent = "Edit time log";
        dom.modalSub.textContent = ticketKey
          ? `${ticketKey}${ticketTitle ? " — " + ticketTitle : ""}`
          : (ticketTitle || event.title || "Event");

        dom.modalStart.value = event.start ? toLocalInputValue(event.start) : "";
        dom.modalEnd.value = event.end ? toLocalInputValue(event.end) : "";
        dom.modalNotes.value = event.extendedProps.notes || "";

        dom.modalOverlay.classList.add("open");
        setTimeout(() => dom.modalNotes.focus(), 50);
      }

      function closeModal() {
        ui.activeEventId = null;
        dom.modalOverlay.classList.remove("open");
      }

      function getActiveEvent() {
        if (!ui.activeEventId || !calendar) return null;
        return calendar.getEventById(ui.activeEventId);
      }

      // -----------------------------
      // Storage I/O
      // -----------------------------
      async function loadAll() {
        const [t, e] = await Promise.all([
          DB.getItem(KEYS.tickets),
          DB.getItem(KEYS.events)
        ]);

        tickets = Array.isArray(t) ? t : [];
        const events = Array.isArray(e) ? e : [];

        // Basic sanity cleanup
        tickets = tickets.filter(x => x && x.id && x.ticketKey);
        return events;
      }

      async function saveTickets() {
        await DB.setItem(KEYS.tickets, tickets);
      }

      const saveEventsDebounced = debounce(async () => {
        if (!calendar) return;
        const events = serializeCalendarEvents(calendar);
        await DB.setItem(KEYS.events, events);
      }, 250);

      // -----------------------------
      // Tickets rendering + drag setup
      // -----------------------------
      function computeTicketTotalsForToday() {
        // Sum durations of events that start today (local day)
        const totals = new Map(); // ticketId -> minutes
        if (!calendar) return totals;

        const now = new Date();
        const startDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
        const endDay = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);

        calendar.getEvents().forEach(ev => {
          const tid = ev.extendedProps.ticketId;
          if (!tid || !ev.start) return;

          const s = ev.start;
          const e = ev.end || addMinutes(ev.start, 15);
          if (e < startDay || s > endDay) return;

          const overlapStart = s < startDay ? startDay : s;
          const overlapEnd = e > endDay ? endDay : e;
          const mins = Math.max(0, Math.round((overlapEnd - overlapStart) / 60000));
          totals.set(tid, (totals.get(tid) || 0) + mins);
        });

        return totals;
      }

      function renderTickets() {
        const qDesktop = (dom.ticketSearchInput?.value || "").trim().toLowerCase();
        const qDrawer = (dom.ticketSearchInputDrawer?.value || "").trim().toLowerCase();
        const q = qDrawer || qDesktop;

        const totals = computeTicketTotalsForToday();
        const filtered = q
          ? tickets.filter(t =>
              (t.ticketKey + " " + t.title).toLowerCase().includes(q)
            )
          : tickets.slice();

        dom.ticketsCount.textContent = String(tickets.length);
        dom.ticketsCountDrawer.textContent = String(tickets.length);

        function buildList(container) {
          container.innerHTML = "";
          filtered.forEach(t => {
            const mins = totals.get(t.id) || 0;
            const dur = mins >= 60
              ? `${Math.floor(mins/60)}h ${mins%60}m`
              : `${mins}m`;

            const item = document.createElement("div");
            item.className = "ticketItem";
            item.setAttribute("draggable", "true");
            item.dataset.ticketId = t.id;
            item.dataset.ticketKey = t.ticketKey;
            item.dataset.ticketTitle = t.title;

            const handle = document.createElement("div");
            handle.className = "dragHandle";

            const body = document.createElement("div");
            body.className = "ticketBody";

            const key = document.createElement("div");
            key.className = "ticketKey";
            key.textContent = t.ticketKey;

            const title = document.createElement("div");
            title.className = "ticketTitle";
            title.textContent = t.title;

            const meta = document.createElement("div");
            meta.className = "ticketMeta";

            const badge = document.createElement("div");
            badge.className = "badge";
            badge.textContent = `Today: ${dur}`;

            const actions = document.createElement("div");
            actions.style.display = "flex";
            actions.style.gap = "6px";

            const del = document.createElement("button");
            del.className = "iconBtn danger";
            del.title = "Delete ticket (also removes its time blocks)";
            del.textContent = "Del";
            del.addEventListener("click", async (ev) => {
              ev.stopPropagation();
              const ok = confirm(`Delete ticket ${t.ticketKey}?\nThis also deletes its time blocks.`);
              if (!ok) return;

              // Remove events for this ticket
              if (calendar) {
                calendar.getEvents().forEach(e => {
                  if (e.extendedProps.ticketId === t.id) e.remove();
                });
              }

              tickets = tickets.filter(x => x.id !== t.id);
              await saveTickets();
              renderTickets();
              saveEventsDebounced();
            });

            actions.appendChild(del);
            meta.appendChild(badge);
            meta.appendChild(actions);

            body.appendChild(key);
            body.appendChild(title);
            body.appendChild(meta);

            item.appendChild(handle);
            item.appendChild(body);

            container.appendChild(item);
          });
        }

        buildList(dom.ticketListDesktop);
        buildList(dom.ticketListDrawer);
        // Reinitialize Draggable after DOM re-render
        initExternalDrag();
      }

      let draggableDesktop = null;
      let draggableDrawer = null;

      function initExternalDrag() {
        // Destroy old draggable instances (prevents duplicate handlers)
        try { draggableDesktop && draggableDesktop.destroy(); } catch(e) {}
        try { draggableDrawer && draggableDrawer.destroy(); } catch(e) {}

        const makeDraggable = (container) => {
          if (!container) return null;
          return new FullCalendar.Draggable(container, {
            itemSelector: ".ticketItem",
            eventData: function(el) {
              const ticketId = el.dataset.ticketId;
              const ticketKey = el.dataset.ticketKey || "";
              const ticketTitle = el.dataset.ticketTitle || "";
              const title = normalizeTitle(ticketKey, ticketTitle);

              const colors = eventColors(ticketId);
              return {
                title,
                duration: "00:15",
                extendedProps: {
                  ticketId,
                  ticketKey,
                  notes: ""
                },
                ...colors
              };
            }
          });
        };

        draggableDesktop = makeDraggable(dom.ticketListDesktop);
        draggableDrawer = makeDraggable(dom.ticketListDrawer);
      }

      // -----------------------------
      // Ticket add
      // -----------------------------
      async function addTicketFromInputs(keyEl, titleEl) {
        const rawKey = keyEl.value;
        const rawTitle = titleEl.value;

        const ticketKey = extractTicketKey(rawKey);
        const title = String(rawTitle || "").trim();

        if (!ticketKey) {
          alert("Please enter a Ticket ID (or a URL that contains one).");
          return;
        }
        if (!title) {
          alert("Please enter a title.");
          return;
        }

        // Prevent duplicates by ticketKey
        const exists = tickets.some(t => t.ticketKey.toLowerCase() === ticketKey.toLowerCase());
        if (exists) {
          alert("That ticket is already in your list.");
          return;
        }

        const ticket = {
          id: safeUUID(),
          ticketKey,
          title,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        tickets.unshift(ticket);

        await saveTickets();
        keyEl.value = "";
        titleEl.value = "";
        renderTickets();
      }

      // -----------------------------
      // CSV export
      // -----------------------------
      function downloadText(filename, text) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 1000);
      }

      function exportCSV() {
        if (!calendar) return;
        const rows = [];
        rows.push(["Start","End","Minutes","TicketKey","Title","Notes"].join(","));

        const safe = (s) => `"${String(s ?? "").replaceAll('"','""')}"`;

        calendar.getEvents()
          .slice()
          .sort((a,b) => (a.start?.getTime()||0) - (b.start?.getTime()||0))
          .forEach(ev => {
            const tid = ev.extendedProps.ticketId;
            const t = tickets.find(x => x.id === tid);
            const start = ev.start ? ev.start.toISOString() : "";
            const end = (ev.end || addMinutes(ev.start, 15)).toISOString();
            const mins = Math.max(0, Math.round((new Date(end) - new Date(start))/60000));
            const ticketKey = ev.extendedProps.ticketKey || (t?.ticketKey || "");
            const title = t?.title || ev.title || "";
            const notes = ev.extendedProps.notes || "";

            rows.push([safe(start), safe(end), mins, safe(ticketKey), safe(title), safe(notes)].join(","));
          });

        const filename = `time-logs-${new Date().toISOString().slice(0,10)}.csv`;
        downloadText(filename, rows.join("\n"));
      }

      // -----------------------------
      // Calendar init
      // -----------------------------
      function initCalendar(initialEvents) {
        const el = document.getElementById("calendar");

        calendar = new FullCalendar.Calendar(el, {
          initialView: "timeGridWeek",
          height: "100%",
          expandRows: true,
          nowIndicator: true,
          editable: true,
          droppable: true,
          eventResizableFromStart: true,
          dayMaxEvents: true,
          navLinks: true,
          selectable: true,
          selectMirror: true,

          // Snap to 15 minutes
          slotDuration: "00:15",
          snapDuration: "00:15",
          slotLabelInterval: "01:00",
          slotMinTime: "06:00:00",
          slotMaxTime: "22:00:00",

          headerToolbar: {
            left: "prev,next",
            center: "title",
            right: ""
          },

          views: {
            timeGridDay: { type: "timeGrid", duration: { days: 1 } },
            timeGridWeek: { type: "timeGrid", duration: { days: 7 } },
            dayGridMonth: { type: "dayGridMonth" },
            listWeek: { type: "listWeek" }
          },

          // Load persisted events
          events: initialEvents.map(e => ({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            allDay: !!e.allDay,
            extendedProps: e.extendedProps || {},
            backgroundColor: e.backgroundColor,
            borderColor: e.borderColor,
            textColor: e.textColor
          })),

          eventReceive: function(info) {
            // Ensure 15-min end exists
            const ev = info.event;

            // If dropped into month view, FullCalendar may mark allDay
            if (ev.allDay) {
              const start = new Date(ev.start);
              // Set a sensible default time (9:00 AM) for month drops
              start.setHours(9, 0, 0, 0);
              ev.setAllDay(false);
              ev.setStart(start);
              ev.setEnd(addMinutes(start, 15));
            } else if (!ev.end) {
              ev.setEnd(addMinutes(ev.start, 15));
            }

            // Force colors (in case)
            const tid = ev.extendedProps.ticketId || ev.id;
            const colors = eventColors(tid);
            ev.setProp("backgroundColor", colors.backgroundColor);
            ev.setProp("borderColor", colors.borderColor);
            ev.setProp("textColor", colors.textColor);

            saveEventsDebounced();
            renderTickets(); // update Today totals
          },

          eventDrop: function() {
            saveEventsDebounced();
            renderTickets();
          },
          eventResize: function() {
            saveEventsDebounced();
            renderTickets();
          },
          eventAdd: function() {
            saveEventsDebounced();
            renderTickets();
          },
          eventRemove: function() {
            saveEventsDebounced();
            renderTickets();
          },
          datesSet: function() {
            // refresh totals when moving around
            renderTickets();
          },

          eventDidMount: function(arg) {
            // Double-click to open editor
            arg.el.addEventListener("dblclick", (e) => {
              e.preventDefault();
              e.stopPropagation();
              openModalForEvent(arg.event);
            });

            // Also support "fast double click" on mobile (some devices don't fire dblclick well)
            arg.el.addEventListener("click", () => {
              const id = arg.event.id;
              const now = Date.now();
              const last = ui.lastClickByEventId.get(id) || 0;
              ui.lastClickByEventId.set(id, now);
              if (now - last < 320) openModalForEvent(arg.event);
            });
          }
        });

        calendar.render();
      }

      // -----------------------------
      // Wire UI events
      // -----------------------------
      function wireUI() {
        // Drawer
        dom.openDrawerBtn?.addEventListener("click", () => setDrawerOpen(true));
        dom.closeDrawerBtn?.addEventListener("click", () => setDrawerOpen(false));
        dom.drawerOverlay?.addEventListener("click", () => setDrawerOpen(false));

        // Add ticket (desktop + drawer)
        dom.addTicketBtn.addEventListener("click", () => addTicketFromInputs(dom.ticketKeyInput, dom.ticketTitleInput));
        dom.addTicketBtnDrawer.addEventListener("click", () => addTicketFromInputs(dom.ticketKeyInputDrawer, dom.ticketTitleInputDrawer));

        // Enter key submit
        [dom.ticketKeyInput, dom.ticketTitleInput, dom.ticketKeyInputDrawer, dom.ticketTitleInputDrawer].forEach((el) => {
          el.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              e.preventDefault();
              if (el === dom.ticketKeyInput || el === dom.ticketTitleInput) {
                addTicketFromInputs(dom.ticketKeyInput, dom.ticketTitleInput);
              } else {
                addTicketFromInputs(dom.ticketKeyInputDrawer, dom.ticketTitleInputDrawer);
              }
            }
          });
        });

        // Search
        dom.ticketSearchInput.addEventListener("input", renderTickets);
        dom.ticketSearchInputDrawer.addEventListener("input", renderTickets);

        // Export
        dom.exportBtn.addEventListener("click", exportCSV);
        dom.exportBtnDrawer.addEventListener("click", exportCSV);

        // Calendar view buttons
        document.querySelectorAll("[data-view]").forEach(btn => {
          btn.addEventListener("click", () => {
            const view = btn.getAttribute("data-view");
            calendar.changeView(view);

            // On very small screens, close drawer so calendar is visible
            if (window.matchMedia("(max-width: 980px)").matches) setDrawerOpen(false);
          });
        });

        dom.todayBtn.addEventListener("click", () => calendar.today());

        // Modal controls
        dom.closeModalBtn.addEventListener("click", closeModal);
        dom.cancelModalBtn.addEventListener("click", closeModal);

        dom.modalOverlay.addEventListener("click", (e) => {
          if (e.target === dom.modalOverlay) closeModal();
        });

        dom.saveModalBtn.addEventListener("click", async () => {
          const ev = getActiveEvent();
          if (!ev) return closeModal();

          const s = fromLocalInputValue(dom.modalStart.value);
          const e = fromLocalInputValue(dom.modalEnd.value);
          if (!s || !e || e <= s) {
            alert("Please enter a valid Start/End (End must be after Start).");
            return;
          }

          // Snap to 15 minute increments (best effort)
          const snap = (d) => {
            const ms = d.getTime();
            const fifteen = 15 * 60 * 1000;
            return new Date(Math.round(ms / fifteen) * fifteen);
          };

          const s2 = snap(s);
          const e2 = snap(e);

          ev.setStart(s2);
          ev.setEnd(e2);
          ev.setExtendedProp("notes", dom.modalNotes.value || "");

          saveEventsDebounced();
          renderTickets();
          closeModal();
        });

        dom.deleteEventBtn.addEventListener("click", () => {
          const ev = getActiveEvent();
          if (!ev) return closeModal();
          const ok = confirm("Delete this time block?");
          if (!ok) return;
          ev.remove();
          saveEventsDebounced();
          renderTickets();
          closeModal();
        });

        // Escape closes modal / drawer
        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape") {
            if (dom.modalOverlay.classList.contains("open")) closeModal();
            if (ui.drawerOpen) setDrawerOpen(false);
          }
        });

        // Keep drawer inputs mirrored (nice UX)
        dom.ticketKeyInput.addEventListener("input", () => dom.ticketKeyInputDrawer.value = dom.ticketKeyInput.value);
        dom.ticketTitleInput.addEventListener("input", () => dom.ticketTitleInputDrawer.value = dom.ticketTitleInput.value);
        dom.ticketKeyInputDrawer.addEventListener("input", () => dom.ticketKeyInput.value = dom.ticketKeyInputDrawer.value);
        dom.ticketTitleInputDrawer.addEventListener("input", () => dom.ticketTitleInput.value = dom.ticketTitleInputDrawer.value);
      }

      // -----------------------------
      // Boot
      // -----------------------------
      (async function boot() {
        // Load saved data
        const initialEvents = await loadAll();

        // Init UI
        wireUI();

        // Init calendar and tickets
        initCalendar(initialEvents);

        // If events exist but ticket list is missing entries (e.g. imported), reconstruct minimal tickets
        const referencedTicketIds = new Set();
        initialEvents.forEach(e => {
          if (e.extendedProps?.ticketId) referencedTicketIds.add(e.extendedProps.ticketId);
        });

        // Render tickets
        renderTickets();
      })();

    })();
  </script>
</body>
</html>
